name: CI — build · a11y · lighthouse

on:
  push:
    branches: [ main, 'feat/**', 'chore/**' ]
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      node-version: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - name: Install deps
        run: npm ci

  build:
    name: Build and Typecheck
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install deps
        run: npm ci
      - name: Typecheck
        run: |
          if npm run -s typecheck >/dev/null 2>&1; then
            npm run typecheck
          else
            npx tsc --noEmit
          fi
      - name: Build
        run: |
          if npm run -s build >/dev/null 2>&1; then
            npm run build
          else
            echo "No build script found; skipping build step"
          fi

  storybook-build:
    name: Storybook Build (optional)
    runs-on: ubuntu-latest
    needs: build
    if: ${{ always() }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install deps
        run: npm ci
      - name: Build Storybook (if configured)
        id: build-storybook
        run: |
          if npm run -s build-storybook >/dev/null 2>&1; then
            npm run build-storybook --silent
            mkdir -p ./storybook-static
            # build-storybook output defaults to storybook-static
          else
            echo "No build-storybook script found; skipping storybook build"
          fi
      - name: Upload storybook artifact
        if: ${{ success() && steps.build-storybook.outcome == 'success' }}
        uses: actions/upload-artifact@v4
        with:
          name: storybook-static
          path: storybook-static

  a11y:
    name: Accessibility Audit (pa11y / axe)
    runs-on: ubuntu-latest
    needs: storybook-build
    steps:
      - uses: actions/checkout@v4
      - name: Download Storybook artifact
        uses: actions/download-artifact@v4
        with:
          name: storybook-static
          path: ./storybook-static
      - name: Serve storybook (static)
        run: |
          npm install -g http-server
          # serve in background on port 9001
          npx http-server ./storybook-static -p 9001 --silent &
          sleep 2
      - name: Install pa11y-ci
        run: npm i -g pa11y-ci
      - name: Run pa11y-ci accessibility tests
        run: |
          if [ -f .pa11yci ]; then
            pa11y-ci --config .pa11yci --reporter html || true
            pa11y-ci --config .pa11yci --reporter json > pa11y-report.json || true
            jq '.results[].issues[] | select(.severity == "error" or .code | test("WCAG"))' pa11y-report.json || true
            # Exit non-zero if any errors found (severity "error" or critical WCAG)
            ERR_COUNT=$(jq '[.results[].issues[] | select(.severity == "error" or (.code|test("WCAG")))] | length' pa11y-report.json)
            echo "A11Y ERR_COUNT=$ERR_COUNT"
            if [ "$ERR_COUNT" -gt 0 ]; then
              echo "Accessibility issues found"
              exit 1
            fi
          else
            echo ".pa11yci not found; running pa11y with default URL"
            pa11y http://localhost:9001 || exit 1
          fi

  lighthouse:
    name: Lighthouse CI (optional)
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install LHCI
        run: npm install -g @lhci/cli@0.11.0
      - name: Check for LHCI_URL secret
        run: |
          if [ -n "${{ secrets.LHCI_URL }}" ]; then
            echo "LHCI_URL configured"
          else
            echo "LHCI_URL not configured - skipping LHCI autorun"
            exit 78
          fi
      - name: Run LHCI autorun
        env:
          LHCI_BUILD_CONTEXT__CURRENT_BRANCH: ${{ github.ref_name }}
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN || '' }}
        run: |
          npx lhci autorun --upload.target=temporary-public-storage || true

